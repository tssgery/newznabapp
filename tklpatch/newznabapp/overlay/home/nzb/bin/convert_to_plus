#!/bin/bash

####################################################
# Script to upgrade from Newznab to Newznab Plus
####################################################

function get_value () {
   TTT=`grep $1 $2`

   TTT=`echo "${TTT}" | cut -d\' -f4`

   echo "${TTT}"
}

# make sure the update scripts are stopped
/etc/init.d/newznab stop

# pull down the latest code from SVN
cd /home/nzb
svn co --username svnplus svn://svn.newznab.com/nn/branches/nnplus

# copy in the config files from old installation
cp /home/nzb/newznab/www/config.php /home/nzb/nnplus/www

# we need to get some values for the database from config.php
DB_USER=`get_value DB_USER /home/nzb/nnplus/www/config.php`
DB_PASSWORD=`get_value DB_PASSWORD /home/nzb/nnplus/www/config.php`
DB_HOST=`get_value DB_HOST /home/nzb/nnplus/www/config.php`
DB_NAME=`get_value DB_NAME /home/nzb/nnplus/www/config.php`

echo "USER: ${DB_USER}"
echo "PASS: ${DB_PASSWORD}"
echo "HOST: ${DB_HOST}"
echo "NAME: ${DB_NAME}"

# run the patch scripts in /home/nzb/nnplus/db/patch/0.2.3
for f in $( find /home/nzb/nnplus/db/patch/0.2.3 -type f -name \*.sql | sort )
do
  echo "Processing $f file..."
  # take action on each file. $f store current file name
  mysql --user=${DB_USER} --password=${DB_PASSWORD} ${DB_NAME} < $f
done

# move the www link
rm /home/nzb/newznab
ln -s /home/nzb/nnplus /home/nzb/newznab

# restart apache2
/etc/init.d/apache2 restart

# restart the update scripts
/etc/init.d/newznab start

